<div>
    <h1 class="title-realTimeProducts">Mis productos</h1>

    <div id="product-form">
        <form action="http://localhost:8080/api/products" method="post" enctype="multipart/form-data">
            <input type="text" name="nombre" placeholder="Nombre" required />
            <input type="text" name="marca" placeholder="Marca" required />
            <input type="text" name="genero" placeholder="Genero" required />
            <input type="text" name="categoria" placeholder="Categoria" required />
            <input type="number" step="0.01" name="precio" placeholder="Precio" required />
            <input type="file" name="file" required />
            <button type="submit">Agregar Producto</button>
        </form>
    </div>



    <article id="product-container">
    {{#each products}}
        <div class="product-card" data-id="{{this.id}}">
            <h2 class="product-name">{{this.nombre}}</h2>
                <h3 class="product-brand">{{this.marca}}</h3>
                <p class="product-category">{{this.categoria}} - {{this.genero}}</p>
                <img src="{{this.thumbnail}}" alt="{{this.nombre}}" class="product-image"/>
                <p class="product-price">$ {{this.precio}}</p>
                <div class="button-group">
                    <button type="button" class="edit-product" data-id="{{this.id}}">Modificar</button>
                    <button type="button" class="delete-product" data-id="{{this.id}}">Eliminar</button>
                </div>
        </div>
    {{/each}}
    </article>
</div>

<!-- Modal para editar producto -->
<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Modificar Producto</h2>
        <form id="edit-form">
            <input type="hidden" id="edit-id" />
            <input type="text" id="edit-nombre" placeholder="Nombre" required />
            <input type="text" id="edit-marca" placeholder="Marca" required />
            <input type="text" id="edit-genero" placeholder="Género" required />
            <input type="text" id="edit-categoria" placeholder="Categoría" required />
            <input type="number" step="0.01" id="edit-precio" placeholder="Precio" required />
            <button type="submit">Guardar Cambios</button>
        </form>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const modal = document.getElementById('edit-modal');
    const closeBtn = document.querySelector('.close');
    const editForm = document.getElementById('edit-form');
    
    // Inicializar productos desde el servidor
    let currentProducts = [
        {{#each products}}
        {
            id: "{{this.id}}",
            nombre: "{{this.nombre}}",
            marca: "{{this.marca}}",
            genero: "{{this.genero}}",
            categoria: "{{this.categoria}}",
            precio: {{this.precio}},
            thumbnail: "{{this.thumbnail}}"
        }{{#unless @last}},{{/unless}}
        {{/each}}
    ];

    // Manejar click en botón de eliminar
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-product')) {
            const productId = e.target.dataset.id;
            if (productId) {
                socket.emit('deleteProduct', productId);
            }
        }

        // Manejar click en botón de modificar
        if (e.target.classList.contains('edit-product')) {
            const productId = e.target.dataset.id;
            console.log('Producto ID:', productId);
            console.log('Productos actuales:', currentProducts);
            
            const product = currentProducts.find(p => p.id === productId);
            console.log('Producto encontrado:', product);
            
            if (product) {
                // Rellenar el formulario con los datos actuales
                document.getElementById('edit-id').value = product.id;
                document.getElementById('edit-nombre').value = product.nombre;
                document.getElementById('edit-marca').value = product.marca;
                document.getElementById('edit-genero').value = product.genero || '';
                document.getElementById('edit-categoria').value = product.categoria;
                document.getElementById('edit-precio').value = product.precio;
                
                // Mostrar el modal
                console.log('Mostrando modal...');
                modal.style.display = 'block';
            } else {
                console.error('Producto no encontrado');
            }
        }
    });

    // Cerrar modal al hacer click en X
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    // Cerrar modal al hacer click fuera de él
    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }

    // Manejar envío del formulario de edición
    editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const productId = document.getElementById('edit-id').value;
        const updatedProduct = {
            nombre: document.getElementById('edit-nombre').value,
            marca: document.getElementById('edit-marca').value,
            genero: document.getElementById('edit-genero').value,
            categoria: document.getElementById('edit-categoria').value,
            precio: parseFloat(document.getElementById('edit-precio').value)
        };
        
        socket.emit('updateProduct', { id: productId, updates: updatedProduct });
        modal.style.display = 'none';
    });

    // Escuchar actualización de productos
    socket.on('updateProducts', (products) => {
        currentProducts = products;
        const container = document.getElementById('product-container');
        container.innerHTML = '';
        
        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.dataset.id = product.id;
            productCard.innerHTML = `
                <h2 class="product-name">${product.nombre}</h2>
                <h3 class="product-brand">${product.marca}</h3>
                <p class="product-category">${product.categoria}${product.genero ? ' - ' + product.genero : ''}</p>
                <img src="${product.thumbnail}" alt="${product.nombre}" class="product-image"/>
                <p class="product-price">$ ${product.precio}</p>
                <div class="button-group">
                    <button type="button" class="edit-product" data-id="${product.id}">Modificar</button>
                    <button type="button" class="delete-product" data-id="${product.id}">Eliminar</button>
                </div>
            `;
            container.appendChild(productCard);
        });
    });
</script>